<div>
    <?php
    $gci = MAGE::getSingleton("googlecmsimport/googlecmsimport");
//    $uri = "http" . (isset($_SERVER['HTTPS'])?"s":""). "://" . $_SERVER["HTTP_HOST"] . $_SERVER['REQUEST_URI'];
//    echo "<!-- originalUri: $uri -->";
//    if(substr($uri,-1)=="/") $uri = substr($uri,0,-1);
//    if(strpos($uri,"?")!==false) $uri = substr($uri,0,strpos($uri,"?"));
    /*echo "<!-- " . "http" . (isset($_SERVER['HTTPS'])?"s":""). "://" . $_SERVER["HTTP_HOST"] . $_SERVER['REQUEST_URI'] . " -->";
    echo "<pre>";
    echo "Client ID:\t"     . $this->getClientId() . "\n";
    echo "Client Secret:\t" . $this->getClientSecret() . "\n";
    echo "Request URI:\t"   . $gci->getRequestUri() . "\n";
    echo "Auth Code Set:\t" .($gci->authCodeSet()?"true":"false") . "\n";
    echo "Auth Code:\t"     . $gci->getAuthCode() . "\n";
    $googleSession = $gci->getSession();
    echo "Access Token:\t"  . $googleSession['auth/access_token'] . "\n";
    //echo "Class Methods:\t" . var_export(get_class_methods($gci),true) . "\n";
    echo "Session Val:\t"   . var_export($googleSession,true) . "\n";
    echo "</pre><br/><br/>";*/
    ?>
<?php if(!$this->authed): ?>
    <div id="login" class="login"><a href="<?php echo $this->authUrl;?>">Connect to Google Apps</a></div>
<?php else: ?>
    <div id="logout" class="login"><a href="?logout">Disconnect from Google Apps</a></div>
    <h3>Google Import:</h3>
    <div id="dr_results" style="white-space: pre;">
        <?php
//        $rootFolder = "0B9_hVhBJdknvYUNLZWpuclhUUEU";
//        global $drs;
//        $drs = $this->getModel()->getService();
//        $children = $drs->children->listChildren($rootFolder);
//        //echo var_export($children->getItems(),true);
//
//        function getSubs($folderId) {
//            global $drs;
//            $children = $drs->children->listChildren($folderId);
//            foreach($children as $child) {
//                echo "die child";
//                die(var_export($drs->children->get($child),true));
//                echo $child->title;
//                getSubs($child->id);
//            }
//        }
//        getSubs($rootFolder);


//        echo var_export($this->listFiles()->getItems(),true);
//        echo "<br>----------<br>";
//        $top = $this->listFiles()->getItems()[0];
//        $one = $this->listFiles($top->id)->getItems()[0];
//        $two = $this->listFiles($one->id)->getItems()[0];
//        echo $top->title . "/" . $one->title . "/" . $two->title . "<br/>";
//        echo "downloadUrl: " . $two['downloadUrl'] . "<br/>";
//        $text = $this->getModel()->downloadFile($two['downloadUrl']);
//        $lines = explode(chr(0x0D),$text);
//        echo "<pre>";
//        echo var_export($lines,true);
//        echo "</pre>";

//        $this->getModel()->syncDriveFiles();


        /**
         * List All Files in the MagentoImport folder, recursively (up to 3 deep)
         * /
        $all = $this->getModel()->listFiles()->getItems();
        $titles = array();
        foreach($all as $item) {
            $subItems = $this->listFiles($item->id)->getItems();
            echo $item->id ." = ". $item->title." (".count($subItems).")<br/>";
            foreach($subItems as $subItem) {
                $subItems2 = $this->listFiles($subItem->id)->getItems();
                echo "\t - " . $subItem->id . " = " . $subItem->title . " (".count($subItems2).")<br/>";
                if(count($subItems2)==0) continue;
                foreach($subItems2 as $subItem2) {
                    echo "\t\t - " . $subItem2->id . " = " . $subItem2->title . "<br/>";
                }
            }
        }
        / *****************************************************************************************/

        /**
         * Recursively download all files in the 'locations' folder as .txt
         * and save them to the 'locations-txt' directory in /var/MagentoImport
         * /
        $saveLocation = Mage::getBaseDir("var")."/MagentoImport/locations-txt";
        if (!file_exists($saveLocation)) {
            mkdir($saveLocation, 0755, true);
        }
        $locationsId  = "0B9_hVhBJdknvaHdtMUk2QWZJdk0";
        $locations    = $this->getModel()->listFiles($locationsId)->getItems();
        $titles = array();
        foreach($locations as $state) {
            // This $item should be a state folder
            $stateName = $state->title;
            // Create this State Directory if it doesn't exist
            $stateDir  = str_replace(' ',"-",str_replace("'","",$stateName));
            $statePath = $saveLocation.DIRECTORY_SEPARATOR.$stateDir;
            if (!file_exists($statePath)) {
                mkdir($statePath, 0755, true);
            }
            // City Files for this state:
            $cities = $this->listFiles($state->id)->getItems();
            // echo $item->id ." = ". $item->title." (".count($subItems).")<br/>";
            foreach($cities as $city) {
                $cityName = $city->title;
                $cityFile = str_replace(' ',"-",str_replace("'","",$cityName)) . ".txt";
                $cityPath = $statePath.DIRECTORY_SEPARATOR.$cityFile;
                $txtUrl   = $city->exportLinks['text/plain'];
                $cityTxt  = $this->getModel()->downloadFile($txtUrl);
                file_put_contents($cityPath,$cityTxt);
            }
        }
        / ***************************************************************************************/

        /**
         * Parse Word Documents (WORKING, currently docx)
         */
        /*
        $dir = Mage::getBaseDir("media") . "/MagentoImport";
        */
        //$files = glob($dir."/locations/*/*.docx");
        /*
        echo var_export($files, true);
        $wordx = array();
        $wordx[$files[0]] = $this->getModel()->parseWordX($files[0]);
        echo "<pre>";
        echo var_export($wordx,true);
        echo "</pre>";
        */
        ?>
    </div>
<?php endif; ?>
    <div>
    <?php
    $parseDescriptions = false;
    if($parseDescriptions) {
        $io = array(
            "input"     => Mage::getBaseDir("var")."/MagentoImport/Products/Descriptions/RattanOutdoorFurniture*.txt",
            "output"    => Mage::getBaseDir('var')."/MagentoImport/Products/Descriptions/Descriptions.csv"
        );
    } else {
        $io = array(
            "input"     => Mage::getBaseDir("var")."/MagentoImport/locations-txt/*/*.txt",
            "output"    => Mage::getBaseDir("var")."/MagentoImport/locations-txt/locations.sql",
            "parent"    => Mage::getBaseDir("var")."/MagentoImport/locations-txt/"
        );
    }
    $doProcess = true;
    if($doProcess):
    /**
     * Parse .txt from .doc to .csv
     *
     * Parse Word Docs downloaded as txt files (from google docs, done manually for now,
     *  - ^ update - now downloaded from google docs, functionality commented out above -
     * but everything is in place to get the files directly from google drive), and write
     * their contents to a single csv file. This parsing should work just the same on cms pages.
     * There have been paragraph tags with the class 'box-blurb' wrapped around each paragraph of
     * content. Also, commas have be encoded as &comma; which should work, but may be an issue.
     */

    $textFiles = glob($io['input']);
    $descsStr  = '';
    foreach($textFiles as $textFile) {
        $descsStr .= file_get_contents($textFile) .PHP_EOL . "________________".PHP_EOL;
    }
    $descs     = preg_split("/_+[\n\r]/",$descsStr);
    $descArr   = array();
    $props     = array();
    $title     = '';
    $unaccent  = array("á"=>"a","Á"=>"A","à"=>"a","À"=>"A","ă"=>"a","Ă"=>"A","â"=>"a","Â"=>"A","å"=>"a","Å"=>"A","ã"=>"a","Ã"=>"A","ą"=>"a","Ą"=>"A","ā"=>"a","Ā"=>"A","ä"=>"ae","Ä"=>"AE","æ"=>"ae","Æ"=>"AE","ḃ"=>"b","Ḃ"=>"B","ć"=>"c","Ć"=>"C","ĉ"=>"c","Ĉ"=>"C","č"=>"c","Č"=>"C","ċ"=>"c","Ċ"=>"C","ç"=>"c","Ç"=>"C","ď"=>"d","Ď"=>"D","ḋ"=>"d","Ḋ"=>"D","đ"=>"d","Đ"=>"D","ð"=>"dh","Ð"=>"Dh","é"=>"e","É"=>"E","è"=>"e","È"=>"E","ĕ"=>"e","Ĕ"=>"E","ê"=>"e","Ê"=>"E","ě"=>"e","Ě"=>"E","ë"=>"e","Ë"=>"E","ė"=>"e","Ė"=>"E","ę"=>"e","Ę"=>"E","ē"=>"e","Ē"=>"E","ḟ"=>"f","Ḟ"=>"F","ƒ"=>"f","Ƒ"=>"F","ğ"=>"g","Ğ"=>"G","ĝ"=>"g","Ĝ"=>"G","ġ"=>"g","Ġ"=>"G","ģ"=>"g","Ģ"=>"G","ĥ"=>"h","Ĥ"=>"H","ħ"=>"h","Ħ"=>"H","í"=>"i","Í"=>"I","ì"=>"i","Ì"=>"I","î"=>"i","Î"=>"I","ï"=>"i","Ï"=>"I","ĩ"=>"i","Ĩ"=>"I","į"=>"i","Į"=>"I","ī"=>"i","Ī"=>"I","ĵ"=>"j","Ĵ"=>"J","ķ"=>"k","Ķ"=>"K","ĺ"=>"l","Ĺ"=>"L","ľ"=>"l","Ľ"=>"L","ļ"=>"l","Ļ"=>"L","ł"=>"l","Ł"=>"L","ṁ"=>"m","Ṁ"=>"M","ń"=>"n","Ń"=>"N","ň"=>"n","Ň"=>"N","ñ"=>"n","Ñ"=>"N","ņ"=>"n","Ņ"=>"N","ó"=>"o","Ó"=>"O","ò"=>"o","Ò"=>"O","ô"=>"o","Ô"=>"O","ő"=>"o","Ő"=>"O","õ"=>"o","Õ"=>"O","ø"=>"oe","Ø"=>"OE","ō"=>"o","Ō"=>"O","ơ"=>"o","Ơ"=>"O","ö"=>"oe","Ö"=>"OE","ṗ"=>"p","Ṗ"=>"P","ŕ"=>"r","Ŕ"=>"R","ř"=>"r","Ř"=>"R","ŗ"=>"r","Ŗ"=>"R","ś"=>"s","Ś"=>"S","ŝ"=>"s","Ŝ"=>"S","š"=>"s","Š"=>"S","ṡ"=>"s","Ṡ"=>"S","ş"=>"s","Ş"=>"S","ș"=>"s","Ș"=>"S","ß"=>"SS","ť"=>"t","Ť"=>"T","ṫ"=>"t","Ṫ"=>"T","ţ"=>"t","Ţ"=>"T","ț"=>"t","Ț"=>"T","ŧ"=>"t","Ŧ"=>"T","ú"=>"u","Ú"=>"U","ù"=>"u","Ù"=>"U","ŭ"=>"u","Ŭ"=>"U","û"=>"u","Û"=>"U","ů"=>"u","Ů"=>"U","ű"=>"u","Ű"=>"U","ũ"=>"u","Ũ"=>"U","ų"=>"u","Ų"=>"U","ū"=>"u","Ū"=>"U","ư"=>"u","Ư"=>"U","ü"=>"ue","Ü"=>"UE","ẃ"=>"w","Ẃ"=>"W","ẁ"=>"w","Ẁ"=>"W","ŵ"=>"w","Ŵ"=>"W","ẅ"=>"w","Ẅ"=>"W","ý"=>"y","Ý"=>"Y","ỳ"=>"y","Ỳ"=>"Y","ŷ"=>"y","Ŷ"=>"Y","ÿ"=>"y","Ÿ"=>"Y","ź"=>"z","Ź"=>"Z","ž"=>"z","Ž"=>"Z","ż"=>"z","Ż"=>"Z","þ"=>"th","Þ"=>"Th","µ"=>"u","а"=>"a","А"=>"a","б"=>"b","Б"=>"b","в"=>"v","В"=>"v","г"=>"g","Г"=>"g","д"=>"d","Д"=>"d","е"=>"e","Е"=>"e","ё"=>"e","Ё"=>"e","ж"=>"zh","Ж"=>"zh","з"=>"z","З"=>"z","и"=>"i","И"=>"i","й"=>"j","Й"=>"j","к"=>"k","К"=>"k","л"=>"l","Л"=>"l","м"=>"m","М"=>"m","н"=>"n","Н"=>"n","о"=>"o","О"=>"o","п"=>"p","П"=>"p","р"=>"r","Р"=>"r","с"=>"s","С"=>"s","т"=>"t","Т"=>"t","у"=>"u","У"=>"u","ф"=>"f","Ф"=>"f","х"=>"h","Х"=>"h","ц"=>"c","Ц"=>"c","ч"=>"ch","Ч"=>"ch","ш"=>"sh","Ш"=>"sh",'щ' => 'sch', 'Щ' => 'sch', 'ъ' => '', 'Ъ' => '', "ы"=>"y","Ы"=>"y",'ь' => '', 'Ь' => '', "э"=>"e","Э"=>"e","ю"=>"ju","Ю"=>"ju","я"=>"ja",'Я' => 'ja');
    function cleanCsvValue(&$lval,$lkey, $unaccent) {
        $lval = str_replace(array_keys($unaccent), array_values($unaccent), $lval);
        $lval = preg_replace('/^([^\d]*)(\d)\-/',"$1$2 ",$lval);
        return filter_var($lval, FILTER_SANITIZE_SPECIAL_CHARS, array(FILTER_FLAG_ENCODE_LOW,FILTER_FLAG_ENCODE_HIGH));
    }
    function multi_unique($array) {
        foreach ($array as $k=>$na)
            $new[$k] = serialize($na);
        $uniq = array_unique($new);
        foreach($uniq as $k=>$ser)
            $new1[$k] = unserialize($ser);
        return ($new1);
    }
    foreach($descs as $key=>$desc) {
        $descArr[$key] = array(
            'full'  => $desc,
            'lines' => preg_split(
                '/[\n\r]+/',
                $desc
            )
        );
        $lines = array_filter($descArr[$key]['lines']);
        array_walk($lines,"cleanCsvValue",$unaccent);
        $title = filter_var(array_shift($lines),FILTER_SANITIZE_SPECIAL_CHARS,FILTER_FLAG_STRIP_HIGH);
        $props[$key]              = array();
        $props[$key]["title"]     = $title;
        $props[$key]["content"]   = array();
        $props[$key]["keywords"]  = array();
        $contentComplete = false;
        foreach($lines as $prop) {
            if($contentComplete) {
                $keyword = preg_filter('/^([^\:]+)\:.*$/', '$1',$prop);
                if(!is_null($keyword)) {
                    $props[$key]['keywords'][] = $keyword;
                }
            } else {
                if(preg_match('/^\(\d+\)$/',trim($prop))) {
                    $contentComplete = true;
                    continue;
                }
                if(!preg_match('/\'*^\s*\'*$/',trim($prop))) {
                    $props[$key]['content'][] = "<p>".htmlentities(trim($prop),ENT_QUOTES)."</p>";
                }
            }
        }
    }

    $props = array_filter($props);
    usort($props, function($a,$b) {
        return strcasecmp($a['title'],$b['title']);
    });
    $props = multi_unique($props);

    $outputData = '';

    if($parseDescriptions) {
        $csv = 'title,content,keywords'.PHP_EOL;
        foreach($props as $page) {
            if(!(strlen($page['title'])>0&&count($page['content'])>0&&count($page['keywords'])>0)) continue;
            $csv .= "\"".$page['title']."\",";
            $csv .= "\"";
            $csv .= implode("",$page['content']);
            $csv .= "\",";
            $csv .= "\"" . implode(", ",explode(" ",implode(" ",$page['keywords']))) . "\"";
            $csv .= PHP_EOL;
        }
        $outputData = $csv;
    } else {
        // Parsing CMS Pages, Write INSERT statements to sql file.
        $statePageId = array(
            "Alabama"	=>	"50",
            "Alaska"	=>	"51",
            "Arizona"	=>	"32",
            "Arkansas"	=>	"26",
            "California"	=>	"92",
            "Colorado"	=>	"52",
            "Connecticut"	=>	"53",
            "Delaware"	=>	"54",
            "Florida"	=>	"55",
            "Georgia"	=>	"56",
            "Hawaii"	=>	"57",
            "Idaho"	=>	"38",
            "Illinois"	=>	"58",
            "Indiana"	=>	"44",
            "Iowa"	=>	"59",
            "Kansas"	=>	"60",
            "Kentucky"	=>	"61",
            "Louisiana"	=>	"62",
            "Maine"	=>	"63",
            "Maryland"	=>	"64",
            "Massachusetts"	=>	"65",
            "Michigan"	=>	"66",
            "Minnesota"	=>	"67",
            "Mississippi"	=>	"68",
            "Missouri"	=>	"69",
            "Montana"	=>	"70",
            "Nebraska"	=>	"71",
            "Nevada"	=>	"72",
            "New Hampshire"	=>	"73",
            "New Jersey"	=>	"74",
            "New Mexico"	=>	"75",
            "New York"	=>	"76",
            "North Carolina"	=>	"77",
            "North Dakota"	=>	"78",
            "Ohio"	=>	"79",
            "Oklahoma"	=>	"80",
            "Oregon"	=>	"81",
            "Pennsylvania"	=>	"23",
            "Rhode Island"	=>	"82",
            "South Carolina"	=>	"83",
            "South Dakota"	=>	"84",
            "Tennessee"	=>	"85",
            "Texas"	=>	"86",
            "Utah"	=>	"87",
            "Vermont"	=>	"88",
            "Virginia"	=>	"89",
            "Washington"	=>	"90",
            "West Virginia"	=>	"91",
            "Wisconsin"	=>	"24",
            "Wyoming"	=>	"25"
        );
        $cityCount = array();
        foreach($statePageId as $state=>$stateId) {
            $dashState  = str_replace(' ',"-",str_replace("'","",$state));
            $stateFiles = glob($io['parent'].DIRECTORY_SEPARATOR.$dashState.DIRECTORY_SEPARATOR."*.txt");
            $cityCount[$state] = count($stateFiles);
        }
        $cityId  = 500;
        $queries = array();
        // Fix Blank Page Issue
        $props   = array_slice($props,1);
        foreach($props as $page) {
            $titleRegex = '/([^,]+),\s([A-z\'\s]+)\s[Oo]utdoor\s[Pp]atio\s[Ff]urniture.*/';
            $city       = preg_filter($titleRegex,"$1",$page['title']);
            $lcCity     = strtolower($city);
            $dashCity   = str_replace(" ", "-", $lcCity);
            $state      = preg_filter($titleRegex,"$2",$page['title']);
            /* Check For Bad State Name ********************
            if(!$state || stristr($state,"outdoor patio furniture")!==false) {
                die(dumper::dump(
                    array(
                        "title" => $page['title'],
                        "city"  => $city,
                        "state" => $state,
                        "regex" => $titleRegex
                    )
                ));
            } ***********************************************/
            $lcState    = strtolower($state);
            $dashState  = str_replace(" ", "-", $lcState);
            $cont       = implode("",$page["content"]);
            $keywords   = htmlentities(implode(", ",array_unique(explode(" ",implode(" ", $page["keywords"])))),ENT_QUOTES);
            $parentId   = $statePageId[$state];
            $citiesNum  = $cityCount[$state];
            $query = <<<QUERY
REPLACE INTO cms_page_tree
VALUES (
{$cityId},
'{$city}, {$state}',
'one_column',
'{$city}, {$state}, {$keywords}',
'{$cont}',
'locations/{$dashState}/{$dashCity}',
'{$city}, {$state} Outdoor Patio Furniture',
'{$cont}',
NOW(),
NOW(),
1, 0, NULL, NULL, NULL, NULL, NULL, NULL, 1, {$parentId}, '2/22/{$parentId}/{$cityId}', {$citiesNum}, 0, 0, 1
);
QUERY;
            $queries[]= $query;
            $cityId++;
        }
        $outputData = implode(PHP_EOL, $queries);
    }
    $result    = false;
    $resultMsg = '';
    try {
        $result = file_put_contents(
            $io['output'],
            $outputData
        );
    } catch(Exception $e) {
        $resultMsg = $e->getMessage();
    }
    ?>
        <div>Files Read: <?php echo count($textFiles); ?><br>
            <?php foreach($textFiles as $textFile){
                echo $textFile . "<br/>";
            }
            ?>
        </div>
        <div>Records Recorded: <?php echo count($props); ?></div>
        <div>File Contents Written: <?php echo $result ?
                'Successfully':
                'Unsuccessfully<br>Message: '.$resultMsg;
        ?></div>
    <?php endif; ?>
    </div>
</div>