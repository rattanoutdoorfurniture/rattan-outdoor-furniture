<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
?>
<?php $_helper = $this->helper('catalog/output'); ?>
<?php $_product = $this->getProduct(); ?>
<script type="text/javascript">
    var optionsPrice = new Product.OptionsPrice(<?php echo $this->getJsonConfig() ?>);
</script>


<?php $proCats = $_product->getCategoryIds();
    //die(dumper::auto($proCats));
//  foreach ($proCats as $_proCat){
//      $pc = $_proCat;
//  }
  $pc = end($proCats);
  $category = Mage::getModel('catalog/category')->load($pc);
  $url = $this->getUrl($category->getUrlPath()).basename($_product->getProductUrl());
  $_products = $category->getProductCollection();
  $customPro = array();$i=0;$index =0;
  foreach ($_products as $_pro){
      $_pro = Mage::getModel('catalog/product')->load($_pro->getId());
      if ($_pro->getId() == $_product->getId())  $index =  $i;
      $customPro[$i] = $_pro;
      $i++;
  }
  $productId = $_product->getId();
  $proItemNumber = "32" . ($pc<1000?($pc<100?($pc<10?("000".$pc):"00".$pc):"0".$pc):$pc) . "0" . $productId;
?>


<?php
/**
 * New Product Markup Section
 */
?>
<?php
/**
 * @see Mage_Catalog_Model_Product_Option
 */
//    $colorSwatchOptions = $_helper->productAttribute($_product, $_product->getOptions(), 'color');
//    $colorSwatch = current($colorSwatchOptions);
//    $colorSwatches = $colorSwatch->getValues();
    $swatches = array();
//    foreach($colorSwatches as $swatch) {
//        $swatches[] = $swatch->getData();
//    }
?>
<?php $actual_link = "http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]"; ?>
<form class="clearfix" action="<?php echo $this->getSubmitUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>

<?php echo $this->getBlockHtml('formkey') ?>

<div class="no-display">
    <input type="hidden" name="product" value="<?php echo $_product->getId() ?>" />
    <input type="hidden" name="related_product" id="related-products-field" value="" />
</div>

<?php echo $this->getChildHtml('media') ?>

<?php if(preg_match("/\<img.*\>/",$this->getChildHtml('media'))): ?>
<section id="product-details" class="nine columns">
<?php else: ?>
<section id="product-details" class="nine columns offset-by-three-important offset-by-half by-margin">
<?php endif; ?>

    <!-- Product Title ----------------------------------------------------------------->

    <h1 id="product-details-title"><?php echo $productName = $_helper->productAttribute($_product, $_product->getName(), 'name') ?></h1>

    <!-- Text Below Title Section ------------------------------------------------------->

    <div id="product-details-sub">
        <span id="product-details-sub-review">
            <?php //echo $this->getReviewsSummaryHtml($_product, false, true)?>
            <span id="product-details-sub-review-stars" class="review-stars _00"></span>
            <span id="product-details-sub-review-text">
                Be the first to <a href="#product-tabs-reviews" title="Write a Review" onclick="jQuery('#product-tabs-reviews').find('a').trigger('click');"> write a review</a>
            </span>
        </span>
        <!-- REMOVE ITEM NUMBER -->
        <!--<span class="product-details-sub-pipe">|</span>-->
        <!--<span id="product-details-sub-item"><?php /*echo $this->__("Item #: "); */?><?php /*echo $proItemNumber; */?></span>-->
        <span class="product-details-sub-pipe">|</span>
        <span id="product-details-sub-model"><?php echo $this->__("Model #: "); ?><?php echo $_helper->productAttribute($_product, $_product->getSKU(), 'sku') ?></span>
    </div>

    <!-- Pricing Section -------------------------------------------------------------->
    <?php //echo $this->getTierPriceHtml($_product,$category) ?>
    <div id="product-details-price" class="clearfix">
        <section id="product-details-price-original" class="product-details-price-section">
            <span id="product-details-price-original-label" class="product-details-price-label"><?php echo $this->__("Regular Price"); ?></span>
            <span id="product-details-price-original-price" class="product-details-price-amount">$<?php echo number_format($_helper->productAttribute($_product, $_product->getMsrp(), 'msrp'),0) ?></span>        </section>
        <section id="product-details-price-separator"></section>
        <section id="product-details-price-sale" class="product-details-price-section">
            <span id="product-details-price-sale-label" class="product-details-price-label"><?php echo $this->__("Sale Price"); ?></span>
            <span id="product-details-price-sale-price" class="product-details-price-amount">$<?php echo number_format($_helper->productAttribute($_product, $_product->getPrice(), 'price'),0) ?></span>
        </section>
    </div>

    <!-- Special Offer Section ------------------------------------------------------->

    <div id="product-details-special">
        <span id="product-details-special-label">Special Offers:</span>
        <span id="product-details-special-text">Spend $ 2,000 and save an extra <mark class="purpText">10%</mark></span>
    </div>
    <?php if ($_product->isSaleable()):?>

        <!-- Color and Quantity Section --------------------------------------------------->

        <div class="product-details-options" class="clearfix">
            <?php echo $this->getChildChildHtml('container2', '', true, true) ?>
        </div>

        <!-- Call to Action buttons For Products Without Color Options --------------------->

        <?php /*if (!$this->hasOptions()):?>
            <div class="add-to-box">
                <?php if($_product->isSaleable()): ?>
                    <?php echo $this->getChildHtml('addtocart') ?>
                    <?php if( $this->helper('wishlist')->isAllow() || $_compareUrl=$this->helper('catalog/product_compare')->getAddUrl($_product)): ?>
                        <span class="or"><?php echo $this->__('OR') ?></span>
                    <?php endif; ?>
                <?php endif; ?>
                <?php echo $this->getChildHtml('addto') ?>
            </div>
            <?php echo $this->getChildHtml('extra_buttons') ?>
        <?php elseif (!$_product->isSaleable()): ?>
            <div class="add-to-box">
                <?php echo $this->getChildHtml('addto') ?>
            </div>
        <?php endif;*/ ?>

    <div id="product-details-social">
        <div class="fb-share-button" data-href="<?php echo "http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]"; ?>" data-type="icon_link"></div>
        <!-- Remove Facebook Old-School Share Link in exchange for the above javascript share button -----------
        <a href="https://www.facebook.com/sharer/sharer.php?u=<?php echo urlencode("http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]"); ?>"
           target="_blank"
           class="product-details-social-btn fb">Facebook</a>
        ------------------------------------------------------------------------------------------------------- -->
        <a href="https://twitter.com/home?status=<?php echo urlencode("Look at this $productName by @Rattanof at http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]"); ?>"
           target="_blank"
           class="product-details-social-btn tw">Twitter</a>
        <a href="https://plus.google.com/share?url=<?php echo urlencode("http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]"); ?>"
           target="_blank"
           class="product-details-social-btn gp">Google Plus</a>
        <a href="<?php echo
        "https://pinterest.com/pin/create/button/?url=".urlencode("http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]") .
        "&media=".urlencode($this->helper('catalog/image')->init($_product, 'image')) .
        "&description=". urlencode($this->getMetaDescription()); ?>"
           target="_blank"
           class="product-details-social-btn pn">Pinterest</a>
        <a href="<?php echo $this->helper('catalog/product')->getEmailToFriendUrl($_product) ?>"
           target="_blank"
           rel="nofollow"
           class="product-details-social-btn em">Email</a>
        <a href="<?php echo
        "http://www.houzz.com/buttonWidget/1" .
        "?url=". urlencode("http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]") .
        "&img=". urlencode($this->helper('catalog/image')->init($_product, 'image')) .
        "&title=". $productName .
        "&hzid=21826".
        "&ref=".urlencode("http://$_SERVER[HTTP_HOST]"); ?>"
           target="_blank"
           class="product-details-social-btn hz">Houzz</a>
        <a href=""
           target="_blank"
           class="product-details-social-btn ig displaynone">Instagram</a>
    </div>
    <?php endif;?>

    <!-- Social Media Buttons Area -------------------------------------------------------->

        <div id="product-details-btns">
            <section id="product-details-btns-add" class="product-details-btn">
                <button id="product-details-btns-add-btn" class="product-details-btn-img" onclick="productAddToCartForm.submit(this)">Add To Cart</button>
            </section>
            <section id="product-details-btns-checkout" class="product-details-btn">
                <button id="product-details-btns-checkout-btn" class="product-details-btn-img" onclick="productAddToCartForm.submit(this)">Checkout</button>
            </section>
        </div>

</section>


<!-- Page Tabs Section ---------------------------------------------------------------------->

<article id="product-tabs" class="sixteen columns">
    <?php
        $detailedInfo       =  $this->getChildGroup('detailed_info', 'getChildHtml');
        $detialedInfoCopy   = array_slice($detailedInfo, 0, 1);
        $detailedInfoFirst  = array_shift($detialedInfoCopy);
        foreach ($detailedInfo as $alias => $html):?>
        <section id="product-tabs-<?php echo $alias;?>" class="product-tab<?php echo ($html==$detailedInfoFirst) ? $this->__(" active") : ''; ?>">
            <h2 class="product-tab-title"><a href="#product-tabs-<?php echo $alias;?>"><?php echo strlen($title = $this->getChildData($alias, 'title')) ? $this->escapeHtml($title) : $this->__("Overview"); ?></a></h2>
            <div class="product-tab-body">
                <?php
                /**
                 * Not sure which of these methods will be most efficient. We can do speed tests.
                 */
                /*
                $html = '<div id="product-tab-body-'.$alias.'">'.PHP_EOL.$html.PHP_EOL.'</div>'.PHP_EOL;
                $dom = new DOMDocument('1.0', 'iso-8859-1');
                $dom->xmlStandalone = false;
                $dom->loadHTML($html);
                $xml = simplexml_load_string($dom->saveXML());
                $arr = $xml->xpath('//div[@class="std"]');
                foreach($arr as $elem) {
                    echo $elem->asXML();
                }
            */
                ?>
                <?php $_description = $this->getProduct()->getDescription(); ?>
                <?php echo $this->helper('catalog/output')->productAttribute($this->getProduct(), $_description, 'description') ?>
            </div>
        </section>
    <?php endforeach;?>
    <section id="product-tabs-faq" class="product-tab">
        <h2 class="product-tab-title"><a href="#product-tabs-faq">FAQ & Help</a></h2>
        <div class="product-tab-body">
            <p class="ease-loading">Loading...</p>
            <?php // echo Mage::app()->getLayout()->createBlock('cms/block')->setBlockId('product-faq')->toHtml(); ?>
        </div>
    </section>
    <section id="product-tabs-special" class="product-tab">
        <h2 class="product-tab-title"><a href="#product-tabs-special">Shipping & Returns</a></h2>
        <div class="product-tab-body">
            <p class="ease-loading">Loading...</p>
            <?php // echo Mage::app()->getLayout()->createBlock('cms/block')->setBlockId('product-special')->toHtml(); ?>
        </div>
    </section>
    <section id="product-tabs-reviews" class="product-tab">
        <h2 class="product-tab-title"><a href="#product-tabs-reviews">Reviews</a></h2>
        <div class="product-tab-body">
            <?php //echo $this->getChildHtml('reviews'); ?>
            <p></p>
            <p><strong>Reviews are curretly unavailable.</strong></p>
            <p>This feature will be available in the near future, so check back soon for reviews.</p>
            <p>You can <a href="javascript:addToFavorites();">bookmark</a> this page and be brought right back to this reviews section.</p>
        </div>
    </section>
</article>

<!-- print this stuff to see what it is -->
<?php //echo $this->getChildHtml('alert_urls') ?>
<?php //echo $this->getChildHtml('product_type_data') ?>
<?php //echo $this->getTierPriceHtml() ?>
<?php //echo $this->getChildHtml('extrahint') ?>

<!--
------------------------------------------------------------------------------
------------------------ Related Product Listings ----------------------------
----------------------------------------------------------------------------->

<?php // echo $this->getChildHtml("related_products"); ?>

<input type="hidden" name="proceedTo" value=""/>

</form>
    <script type="text/javascript">
    //<![CDATA[
        var productAddToCartForm = new VarienForm('product_addtocart_form');
        productAddToCartForm.submit = function(button, url) {
            if (this.validator.validate()) {
                var form = this.form;
                var oldUrl = form.action;

                if(url) {
//                    url = "/checkout/cart/add/product/"
//                        + jQuery("[name=product]").val()
//                        + "/qty/"
//                        + jQuery("[name=qty]").val()
//                        + "/color/"
//                        + jQuery("[name=color").val();
                   form.action = url;
                } else {
                    if(button.id=="product-details-btns-checkout-btn") {
                        form.elements.proceedTo.value += "checkout";
                    }
                }

                var e = null;
                try {
                    this.form.submit();
                } catch (e) {}

                this.form.action = oldUrl;

                if (e) {
                    throw e;
                }

                if (button && button != 'undefined') {
                    button.disabled = true;
                }
            }
        }.bind(productAddToCartForm);

        productAddToCartForm.submitLight = function(button, url){
            if(this.validator) {
                var nv = Validation.methods;
                delete Validation.methods['required-entry'];
                delete Validation.methods['validate-one-required'];
                delete Validation.methods['validate-one-required-by-name'];
                // Remove custom datetime validators
                for (var methodName in Validation.methods) {
                    if (methodName.match(/^validate-datetime-.*/i)) {
                        delete Validation.methods[methodName];
                    }
                }

                if (this.validator.validate()) {
                    if (url) {
                        this.form.action = url;
                    }
                    this.form.submit();
                }
                Object.extend(Validation.methods, nv);
            }
        }.bind(productAddToCartForm);
    //]]>
    </script>

<?php echo $this->getChildHtml('product_additional_data') ?>

<?php echo $this->getChildHtml('upsell_products') ?>
